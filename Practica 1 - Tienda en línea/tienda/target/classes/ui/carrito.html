<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrito de Compras - Tienda en L√≠nea</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/carrito.css">
</head>
<body>
  <div class="container">
    <div class="carrito-container">
      <div class="carrito-header">
        <h1 class="carrito-titulo">üõí Carrito de Compras</h1>
        <div class="carrito-contador" id="contador">0 art√≠culos</div>
      </div>
      
      <div class="carrito-items" id="carrito-items">
        <!-- Los items del carrito se insertar√°n aqu√≠ -->
      </div>
      
      <div class="carrito-total" id="carrito-total" style="display: none;">
        <div class="total-label">Total a pagar:</div>
        <div class="total-amount" id="total-amount">$0.00</div>
      </div>
      
      <div class="carrito-vacio" id="carrito-vacio">
        <span class="emoji">üõí</span>
        <div>Tu carrito est√° vac√≠o</div>
        <div style="margin-top: 10px; font-size: 0.9em; color: #bbb;">
          Agrega algunos productos para comenzar
        </div>
      </div>
      
      <div class="acciones" id="acciones" style="display: none;">
        <button class="btn btn-primary" onclick="procederCompra()">
          üí≥ Proceder al Pago
        </button>
        <button class="btn btn-secondary" onclick="vaciarCarrito()">
          üóëÔ∏è Vaciar Carrito
        </button>
      </div>
    </div>
  </div>
  
  <script>
    let carritoData = [];
    
    // Funci√≥n para cargar carrito desde localStorage
    function cargarCarritoDesdeStorage() {
      try {
        const carritoTemporal = localStorage.getItem('carritoTemporal');
        if (carritoTemporal) {
          carritoData = JSON.parse(carritoTemporal);
          console.log("Carrito cargado desde localStorage:", carritoData);
          return true;
        }
        return false;
      } catch (error) {
        console.error("Error al cargar carrito desde localStorage:", error);
        return false;
      }
    }
    
    // Nueva funci√≥n que Java llama con array completo y total
    function mostrarCarritoCompleto(carritoArrayJson, totalCarrito) {
      try {
        // Parsear el array JSON que viene de Java
        carritoData = JSON.parse(carritoArrayJson);
        console.log("Carrito recibido desde Java:", carritoData);
        console.log("Total:", totalCarrito);
        
        renderizarCarrito();
      } catch (error) {
        console.error("Error al parsear carrito desde Java:", error);
        mostrarError("Error al cargar el carrito desde Java");
      }
    }
    
    // Funci√≥n para mostrar errores
    function mostrarError(mensaje) {
      const itemsContainer = document.getElementById('carrito-items');
      itemsContainer.innerHTML = `
        <div class="error-message" style="text-align: center; padding: 40px; color: #e53e3e; background: #fed7d7; border-radius: 8px; margin: 20px 0;">
          <h3>‚ö†Ô∏è Error</h3>
          <p>${mensaje}</p>
        </div>
      `;
    }
    
    // Funci√≥n legacy para compatibilidad
    function mostrarCarrito(carritoString) {
      console.log("Datos del carrito recibidos (string):", carritoString);
      parseCarritoData(carritoString);
      renderizarCarrito();
    }
    
    function parseCarritoData(carritoString) {
      try {
        carritoData = JSON.parse(carritoString);
      } catch (error) {
        console.error("Error al parsear carrito:", error);
        carritoData = [];
      }
    }
    
    function renderizarCarrito() {
      const itemsContainer = document.getElementById('carrito-items');
      const contadorElement = document.getElementById('contador');
      const totalElement = document.getElementById('carrito-total');
      const vacioElement = document.getElementById('carrito-vacio');
      const accionesElement = document.getElementById('acciones');
      const totalAmountElement = document.getElementById('total-amount');
      
      // Limpiar contenido
      itemsContainer.innerHTML = '';
      
      if (!carritoData || carritoData.length === 0) {
        // Mostrar carrito vac√≠o
        vacioElement.style.display = 'block';
        totalElement.style.display = 'none';
        accionesElement.style.display = 'none';
        contadorElement.textContent = '0 art√≠culos';
      } else {
        // Mostrar items
        vacioElement.style.display = 'none';
        totalElement.style.display = 'block';
        accionesElement.style.display = 'flex';
        
        let total = 0;
        
        carritoData.forEach((item, index) => {
          const itemElement = document.createElement('div');
          itemElement.className = 'carrito-item';
          itemElement.innerHTML = `
            <div class="item-info">
              <div class="item-nombre">${item.nombre}</div>
              <div class="item-marca">üè∑Ô∏è ${item.marca}</div>
              <div class="item-categoria">üìÇ ${item.categoria}</div>
              <div class="item-descripcion">${item.descripcion}</div>
            </div>
            <div class="item-actions">
              <div class="item-precio">$${Number(item.precio).toFixed(2)}</div>
              <button class="btn-eliminar" onclick="eliminarProducto(${index})" title="Eliminar producto">
                üóëÔ∏è
              </button>
            </div>
          `;
          itemsContainer.appendChild(itemElement);
          total += Number(item.precio);
        });
        
        // Actualizar contador y total
        contadorElement.textContent = `${carritoData.length} art√≠culo${carritoData.length !== 1 ? 's' : ''}`;
        totalAmountElement.textContent = `$${total.toFixed(2)}`;
      }
    }
    
    function procederCompra() {
      //TODO
    }
    
    function vaciarCarrito() {
      const cantidadItems = carritoData.length;

      // Limpiar datos
      carritoData = [];
      localStorage.removeItem('carritoTemporal');
      
      renderizarCarrito();
    }
    
    // Funci√≥n para eliminar un producto espec√≠fico del carrito
    function eliminarProducto(index) {
      const producto = carritoData[index];
        carritoData.splice(index, 1);
        if (carritoData.length > 0) {
          localStorage.setItem('carritoTemporal', JSON.stringify(carritoData));
        } else {
          localStorage.removeItem('carritoTemporal');
        }
        renderizarCarrito();
    }
    
    // Funci√≥n para inicializar el carrito
    function inicializarCarrito() {
      console.log("Inicializando carrito...");
      
      // Intentar cargar desde localStorage primero
      if (cargarCarritoDesdeStorage()) {
        console.log("Carrito cargado desde localStorage");
        renderizarCarrito();
      } else {
        console.log("No hay carrito en localStorage, mostrando vac√≠o");
        // Esperar a que Java llame a mostrarCarritoCompleto o mostrar vac√≠o
        renderizarCarrito();
      }
    }
    
    // Inicializar cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', inicializarCarrito);
    
    // Tambi√©n inicializar inmediatamente por si DOMContentLoaded ya pas√≥
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarCarrito);
    } else {
      inicializarCarrito();
    }
  </script>
</body>
</html>