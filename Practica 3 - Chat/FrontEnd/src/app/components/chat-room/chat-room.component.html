<div class="chat-container">
  <!-- Header -->
  <header class="chat-header">
    <div class="header-left">
      <h1>ğŸ’¬ Chat Grupal</h1>
      @if (chatService.usuarioActual()) {
        <span class="usuario-badge">{{ chatService.usuarioActual()?.nombre }}</span>
      }
    </div>
    <button class="btn-logout" (click)="cerrarSesion()">
      ğŸšª Salir
    </button>
  </header>

  <div class="chat-content">
    @if (!mostrarUnirse() && chatService.salaActual()) {
      <button 
        class="btn-sidebar-toggle" 
        (click)="mostrarUsuarios.set(!mostrarUsuarios())"
        [title]="mostrarUsuarios() ? 'Minimizar usuarios' : 'Maximizar usuarios'"
      >
        {{ mostrarUsuarios() ? 'â—€' : 'â–¶' }}
      </button>
    }

    <!-- Sidebar con usuarios -->
    @if (!mostrarUnirse() && chatService.salaActual()) {
      <aside class="sidebar" [class.hidden]="!mostrarUsuarios()">
        <div class="sidebar-header">
          <h3>ğŸ‘¥ Usuarios en {{ chatService.salaActual()?.nombre }}</h3>
          <button class="btn-icon" (click)="mostrarUsuarios.set(!mostrarUsuarios())" style="display: none;">
            {{ mostrarUsuarios() ? 'â—€' : 'â–¶' }}
          </button>
        </div>
        <ul class="usuarios-list">
          @for (usuario of chatService.usuariosEnSala(); track usuario) {
            <li 
              class="usuario-item"
              [class.usuario-actual]="usuario === chatService.usuarioActual()?.nombre"
              (click)="seleccionarUsuarioPrivado(usuario)"
            >
              <span class="status-dot"></span>
              {{ usuario }}
              @if (usuario === chatService.usuarioActual()?.nombre) {
                <span class="badge-tu">(TÃº)</span>
              }
            </li>
          }
        </ul>
      </aside>
    }

    <!-- Ãrea principal de chat -->
    <main class="main-chat">
      @if (mostrarUnirse()) {
        <div class="unirse-sala-modal">
          <div class="unirse-card">
            <h2>ğŸš€ Unirse a una Sala</h2>
            <p>Ingresa el nombre de la sala a la que deseas unirte</p>
            <form (ngSubmit)="unirseASala()" class="unirse-form">
              <input
                type="text"
                [(ngModel)]="nombreSala"
                name="sala"
                placeholder="Nombre de la sala"
                class="input-sala"
                required
              />
              <button type="submit" class="btn-unirse" [disabled]="!nombreSala()">
                Unirse
              </button>
            </form>
          </div>
        </div>
      } @else {
        <!-- Chat activo -->
        <div class="chat-area">
          <!-- Info de sala -->
          <div class="sala-header">
            <div>
              <h2>ğŸ“ {{ chatService.salaActual()?.nombre }}</h2>
              @if (modoPrivado() && usuarioSeleccionado()) {
                <p class="modo-privado">
                  ğŸ”’ Mensaje privado para: <strong>{{ usuarioSeleccionado() }}</strong>
                  <button class="btn-cancelar-privado" (click)="cancelarModoPrivado()">
                    âœ•
                  </button>
                </p>
              }
            </div>
            <button class="btn-abandonar" (click)="abandonarSala()">
              Abandonar Sala
            </button>
          </div>

          <!-- Mensajes -->
          <div class="mensajes-container" #messagesContainer>
            @if (obtenerMensajesFiltrados().length === 0) {
              <div class="no-mensajes">
                <p>ğŸ‘‹ No hay mensajes aÃºn. Â¡SÃ© el primero en escribir!</p>
              </div>
            } @else {
              @for (mensaje of obtenerMensajesFiltrados(); track mensaje.id) {
                <div 
                  class="mensaje"
                  [class.mensaje-propio]="esMensajePropio(mensaje)"
                  [class.mensaje-privado]="esMensajePrivado(mensaje)"
                  [class.mensaje-emoji]="mensaje.tipo === 'emoji'"
                  [class.mensaje-sticker]="mensaje.tipo === 'sticker'"
                  [class.mensaje-audio]="mensaje.tipo === 'audio'"
                >
                  <div class="mensaje-header">
                    <span class="mensaje-usuario">{{ mensaje.usuario }}</span>
                    @if (esMensajePrivado(mensaje)) {
                      <span class="badge-privado">ğŸ”’ Privado</span>
                    }
                    <span class="mensaje-hora">{{ formatearHora(mensaje.timestamp) }}</span>
                  </div>
                  <div class="mensaje-contenido">
                    @if (mensaje.tipo === 'audio') {
                      <div class="audio-mensaje">
                        <span class="audio-icon">ğŸ¤</span>
                        <audio controls [src]="mensaje.audioData">
                          Tu navegador no soporta el elemento de audio.
                        </audio>
                      </div>
                    } @else if (mensaje.tipo === 'sticker') {
                      <div class="sticker-mensaje">
                        {{ mensaje.contenido }}
                      </div>
                    } @else {
                      {{ mensaje.contenido }}
                    }
                  </div>
                </div>
              }
            }
          </div>

          <!-- Input de mensaje -->
          <div class="input-area">
            @if (grabandoAudio()) {
              <!-- Panel de grabaciÃ³n de audio -->
              <div class="audio-recording-panel">
                <div class="recording-info">
                  <span class="recording-dot">ğŸ”´</span>
                  <span class="recording-time">{{ formatearTiempoGrabacion() }}</span>
                  <span class="recording-text">Grabando audio...</span>
                </div>
                <div class="recording-actions">
                  <button 
                    type="button" 
                    class="btn-cancel-recording"
                    (click)="cancelarGrabacion()"
                  >
                    âŒ Cancelar
                  </button>
                  <button 
                    type="button" 
                    class="btn-stop-recording"
                    (click)="detenerGrabacion()"
                  >
                    â¹ï¸ Enviar
                  </button>
                </div>
              </div>
            } @else {
              @if (mostrarEmojis()) {
                <div class="emoji-picker">
                  @for (emoji of emojis; track emoji) {
                    <button 
                      class="emoji-btn"
                      (click)="enviarEmoji(emoji)"
                    >
                      {{ emoji }}
                    </button>
                  }
                </div>
              }
              
              @if (mostrarStickers()) {
                <div class="sticker-picker">
                  @for (sticker of stickers; track sticker) {
                    <button 
                      class="sticker-btn"
                      (click)="enviarSticker(sticker)"
                    >
                      {{ sticker }}
                    </button>
                  }
                </div>
              }
              
              <form (ngSubmit)="enviarMensaje()" class="mensaje-form">
                <button 
                  type="button" 
                  class="btn-emoji"
                  (click)="toggleEmojis()"
                  title="Emojis"
                >
                  ğŸ˜€
                </button>
                <button 
                  type="button" 
                  class="btn-sticker"
                  (click)="toggleStickers()"
                  title="Stickers"
                >
                  ğŸ¨
                </button>
                <button 
                  type="button" 
                  class="btn-audio"
                  (click)="iniciarGrabacion()"
                  title="Grabar audio"
                >
                  ğŸ¤
                </button>
                <input
                  type="text"
                  [(ngModel)]="nuevoMensaje"
                  name="mensaje"
                  placeholder="Escribe un mensaje..."
                  class="input-mensaje"
                  [attr.maxlength]="500"
                />
                <button 
                  type="submit" 
                  class="btn-enviar"
                  [disabled]="!nuevoMensaje()"
                >
                  ğŸ“¤ Enviar
                </button>
              </form>
            }
          </div>
        </div>
      }
    </main>
  </div>
</div>
